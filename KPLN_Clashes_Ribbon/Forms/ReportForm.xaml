<Window x:Class="KPLN_Clashes_Ribbon.Forms.ReportForm"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
        xmlns:local="clr-namespace:KPLN_Clashes_Ribbon.Forms"
        mc:Ignorable="d" 
        Height="600"
        MaxHeight="1000"
        Width="825"
        MaxWidth="1000"
        SizeToContent="WidthAndHeight"
        FontFamily="Monaco, Consolas, 'Andale Mono', 'DejaVu Sans Mono', monospace" 
        ResizeMode="CanResizeWithGrip" 
        Title="KPLN: Отчет Navisworks" 
        WindowStyle="ToolWindow" 
        Topmost="False" 
        WindowStartupLocation="CenterScreen" 
        Background="#FF292D36">

    <Window.Resources>
        <Style
            x:Key="ItemTBL"
            TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
        </Style>

        <Style
            x:Key="ItemLocalHeaderTBL"
            TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="TextDecorations" Value="Underline"/>
            <Setter Property="Margin" Value="5,0,0,5"/>
        </Style>

        <Style
            x:Key="ItemBTN"
            TargetType="Button">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="{x:Null}"/>
            <Setter Property="BorderBrush" Value="{x:Null}"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style
            x:Key="FilterTBL"
            TargetType="TextBlock">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

        <Style
            x:Key="FilterTBX"
            TargetType="TextBox">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="FontStretch" Value="ExtraExpanded"/>
            <Setter Property="TextAlignment" Value="Left"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.95*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        <Rectangle 
            Grid.RowSpan="3" 
            Grid.ColumnSpan="2" 
            Fill="#FFFFD100"/>

        <!--Фильтрование по имени файла-->
        <StackPanel>
            <TextBlock 
                Text="(И) Фильтр по открытому файлу:" 
                Style="{StaticResource FilterTBL}"/>
            <DockPanel>
                <RadioButton
                    x:Name="AllItemsRB"
                    GroupName="FileNameFilterGroup"
                    IsChecked="True"
                    Content="Все замечания"
                    Margin="5"
                    FontWeight="Bold"
                    Checked="FileNameFilterGroup_Checked">
                </RadioButton>
                <RadioButton
                    x:Name="OnlyForFileItemsRB"
                    GroupName="FileNameFilterGroup"
                    Content="Замечания для открытого файла"
                    Margin="5"
                    FontWeight="Bold"
                    Checked="FileNameFilterGroup_Checked">
                </RadioButton>
            </DockPanel>
        </StackPanel>
        
        <!--Фильтрование по статусу замечания-->
        <StackPanel 
            Grid.Row="1" 
            Grid.Column="0" 
            Orientation="Vertical">
            <TextBlock 
                Text="(И) Фильтр по статусу:" 
                Style="{StaticResource FilterTBL}"/>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <ComboBox 
                    x:Name="StatusFilterCBX" 
                    Grid.Column="0" 
                    SelectedIndex="1" 
                    Margin="5,0,5,5" 
                    SelectionChanged="StatusFilterCBX_SelectionChanged">
                    <ComboBoxItem Content="Все коллизии"/>
                    <ComboBoxItem Content="Открытые и делегированные"/>
                    <ComboBoxItem Content="Открытые"/>
                    <ComboBoxItem Content="Делегированные"/>
                    <ComboBoxItem Content="Допустимые"/>
                    <ComboBoxItem Content="Исправленные"/>
                </ComboBox>
            </Grid>
        </StackPanel>
        
        <!--Экспорт в txt-->
        <Button 
            Grid.Row="1" 
            Grid.Column="1" 
            Margin="5,5,5,5" 
            Content="🖬" 
            Padding="5,1" 
            Background="White" 
            BorderBrush="#FFAA8B00" 
            Foreground="#FFFFD100" 
            Click="OnExport">
            <Button.ToolTip>
                <StackPanel>
                    <TextBlock 
                        TextWrapping="Wrap" 
                        FontWeight="Bold"
                        Margin="0,0,0,5" 
                        Text="Экспорт"/>
                    <TextBlock 
                        TextWrapping="Wrap" 
                        Text="Сохранение отчета в формате .txt"/>
                    <Border 
                        BorderBrush="Silver" 
                        BorderThickness="0,1,0,0" 
                        Margin="0,8" />
                    <TextBlock 
                        TextWrapping="Wrap" 
                        Text="Подсказка: Для импорта в таблицы Excel (Разделитель - «Табуляция»)" 
                        FontStyle="Italic"/>
                </StackPanel>
            </Button.ToolTip>
        </Button>
        
        <!--Фильтрование по атрибутам отчетов-->
        <StackPanel 
            Grid.Row="2" 
            Grid.ColumnSpan="2">
            <DockPanel>
                <TextBlock 
                    Text="(ИЛИ) Фильтр по имени конфликта/группы:" 
                    Style="{StaticResource FilterTBL}"/>
                <TextBox 
                    x:Name="ConflictDataTBx"
                    Style="{StaticResource FilterTBX}"
                    MinHeight="20" 
                    MinWidth="180" 
                    DockPanel.Dock="Left"
                    TextChanged="ConflictDataTBx_TextChanged"/>
                <TextBlock 
                    Text="(ИЛИ) Фильтр по ID-элемента:" 
                    Style="{StaticResource FilterTBL}"/>
                <TextBox 
                    x:Name="IDDataTBx"
                    Style="{StaticResource FilterTBX}"
                    MinHeight="20" 
                    MinWidth="135" 
                    DockPanel.Dock="Left"
                    TextChanged="IDDataTBx_TextChanged"/>
            </DockPanel>
            <DockPanel>
                <TextBlock 
                    Text="(ИЛИ) Фильтр по данным об эл-тах:" 
                    Style="{StaticResource FilterTBL}"/>
                <TextBox 
                    x:Name="ConflictMetaDataTBx"
                    Style="{StaticResource FilterTBX}"
                    MinHeight="20" 
                    Width="580" 
                    DockPanel.Dock="Left"
                    TextChanged="ConflictMetaDataTBx_TextChanged"/>
            </DockPanel>
        </StackPanel>

        <ListBox
            x:Name="ReportControll"
            Grid.Row="3"
            Grid.ColumnSpan="2"
            Margin="0,0,0,17"
            ItemsSource="{Binding FilteredInstancesColl}"
            SelectionMode="Extended"
            HorizontalContentAlignment="Stretch"
            ScrollViewer.CanContentScroll="True"
            VirtualizingPanel.IsVirtualizing="True"
            VirtualizingPanel.ScrollUnit="Pixel">
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="Padding" Value="-5"/>
                    <Setter Property="Margin" Value="0"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <ContentPresenter />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid Margin="3,5,3,5">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="0.5*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!--Информация по группе-->
                        <Rectangle 
                            x:Name="BackgroundRect"
                            Grid.ColumnSpan="2" 
                            Grid.RowSpan="6"
                            Fill="{Binding Fill, UpdateSourceTrigger=PropertyChanged}" 
                            Margin="-3" 
                            RadiusX="3" 
                            RadiusY="3"/>
                        <TextBlock 
                            Grid.Row="0" 
                            Grid.Column="0" 
                            Grid.ColumnSpan="2" 
                            Text="{Binding Name}" 
                            Style="{StaticResource ItemTBL}"
                            Margin="3,2,0,5"/>
                        <Button 
                            Grid.Column="0" 
                            Grid.Row="1"  
                            Width="200" 
                            Height="200" 
                            Content="↻" 
                            Style="{StaticResource ItemBTN}"
                            VerticalAlignment="Top"
                            HorizontalAlignment="Center"
                            Opacity="0.5" 
                            FontSize="64" 
                            Background="Transparent"
                            Click="OnLoadImage"/>
                        <Image 
                            Grid.Row="1" 
                            Grid.Column="0" 
                            Width="200" 
                            Height="200" 
                            VerticalAlignment="Top"
                            Source="{Binding ImageSource, UpdateSourceTrigger=PropertyChanged}"/>
                        <Rectangle 
                            Grid.Row="1"
                            Grid.Column="0" 
                            VerticalAlignment="Top"
                            Margin="3,-3,3,3" 
                            Width="206" 
                            Height="206" 
                            RadiusX="3" 
                            RadiusY="3" 
                            Stroke="White" 
                            StrokeThickness="3"/>
                        <Grid Grid.Row="1" Grid.Column="1">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition/>
                            </Grid.ColumnDefinitions>

                            <!--Комменты от координатора-->
                            <TextBlock 
                                Grid.Row="0" 
                                Grid.Column="0" 
                                Text="Комментарий BIM: " 
                                Visibility="{Binding ReportParentGroupCommentsVisibility}" 
                                Style="{StaticResource ItemLocalHeaderTBL}" 
                                FontWeight="Bold"
                                Foreground="Black"/>
                            <TextBlock 
                                Grid.Row="0" 
                                Grid.Column="1"
                                Text="{Binding ReportParentGroupComments}"  
                                Visibility="{Binding ReportParentGroupCommentsVisibility}" 
                                Style="{StaticResource ItemTBL}"
                                MaxWidth="500"
                                Foreground="Black"/>

                            <!--Список файлов-->
                            <TextBlock 
                                Grid.Row="1" 
                                Grid.Column="0" 
                                Text="Файлы в отчётах: " 
                                Style="{StaticResource ItemLocalHeaderTBL}"/>
                            <TextBlock 
                                Grid.Row="1" 
                                Grid.Column="1"
                                Text="{Binding DocumentsHashSet}"  
                                Style="{StaticResource ItemTBL}"
                                MaxWidth="500"/>

                            <!--Метка-->
                            <TextBlock 
                                Grid.Row="2" 
                                Grid.Column="0" 
                                Text="Найти: " 
                                Visibility="{Binding PlacePointVisibility}" 
                                Style="{StaticResource ItemLocalHeaderTBL}"/>
                            <Button 
                                Grid.Row="2" 
                                Grid.Column="1" 
                                Click="PlacePoint" 
                                Content="፠ Метка/-и пересечения" 
                                Visibility="{Binding PlacePointVisibility}" 
                                Style="{StaticResource ItemBTN}"
                                Background="{x:Null}" 
                                BorderBrush="White" 
                                BorderThickness="2"/>

                            <!--Информация по субэлементам группы-->
                            <TextBlock 
                                Grid.Row="3" 
                                Grid.Column="0" 
                                Text="Субэлементы: " 
                                Visibility="{Binding IsGroup}" 
                                Style="{StaticResource ItemLocalHeaderTBL}"/>
                            <ItemsControl 
                                Grid.Row="4" 
                                Grid.Column="0" 
                                Grid.ColumnSpan="2" 
                                Visibility="{Binding IsGroup}" 
                                ItemsSource="{Binding SubElements}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <Rectangle 
                                                Grid.Row="0" 
                                                Grid.Column="0" 
                                                Grid.ColumnSpan="3" 
                                                Grid.RowSpan="10" 
                                                Margin="-3"  
                                                Fill="#3FFFFFFF" 
                                                RadiusX="3" 
                                                RadiusY="3"/>
                                            <Button 
                                                Grid.Row="1"  
                                                Grid.Column="0" 
                                                Grid.RowSpan="5"  
                                                Width="80" 
                                                Height="80" 
                                                Content="↻" 
                                                Style="{StaticResource ItemBTN}"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Top"
                                                Opacity="0.5" 
                                                Background="Transparent"
                                                FontSize="24" 
                                                Click="OnLoadImage"/>
                                            <Image 
                                                Grid.Row="1" 
                                                Grid.Column="0" 
                                                Grid.RowSpan="5" 
                                                VerticalAlignment="Top" 
                                                Margin="5" 
                                                Width="80" 
                                                Height="80" 
                                                Source="{Binding ImageSource, UpdateSourceTrigger=PropertyChanged}"/>

                                            <!--Элемент 1-->
                                            <TextBlock 
                                                Grid.Row="0" 
                                                Grid.Column="0" 
                                                Grid.ColumnSpan="2"
                                                Text="{Binding Name}" 
                                                Style="{StaticResource ItemLocalHeaderTBL}"
                                                FontSize="12" 
                                                HorizontalAlignment="Left"/>
                                            <TextBlock 
                                                Grid.Row="1" 
                                                Grid.Column="1" 
                                                Text="Файл 1: "
                                                Style="{StaticResource ItemLocalHeaderTBL}"/>
                                            <TextBlock 
                                                Grid.Row="1" 
                                                Grid.Column="2" 
                                                Text="{Binding Element_1_DocName}"
                                                Style="{StaticResource ItemTBL}"/>
                                            <TextBlock 
                                                Grid.Row="2" 
                                                Grid.Column="1" 
                                                Text="Id 1: " 
                                                Style="{StaticResource ItemLocalHeaderTBL}"
                                                FontSize="12"/>
                                            <Button 
                                                Grid.Row="2" 
                                                Grid.Column="2" 
                                                Content="{Binding Element_1_Id}" 
                                                Style="{StaticResource ItemBTN}"
                                                VerticalContentAlignment="Top" 
                                                Click="SelectIdElement_1"
                                                FontSize="10"/>
                                            <TextBlock 
                                                Grid.Row="3" 
                                                Grid.Column="1" 
                                                Text="Данные 1: " 
                                                Style="{StaticResource ItemLocalHeaderTBL}"
                                                FontSize="12"/>
                                            <Expander
                                                Grid.Row="3" 
                                                Grid.Column="2"
                                                IsExpanded="False">
                                                <TextBlock 
                                                    Text="{Binding Element_1_Info}"
                                                    Style="{StaticResource ItemTBL}"
                                                    MaxWidth="300"/>
                                            </Expander>

                                            <!--Элемент 2-->
                                            <TextBlock 
                                                Grid.Row="4" 
                                                Grid.Column="1" 
                                                Text="Файл 1: "
                                                Style="{StaticResource ItemLocalHeaderTBL}"/>
                                            <TextBlock 
                                                Grid.Row="4" 
                                                Grid.Column="2" 
                                                Text="{Binding Element_2_DocName}"
                                                Style="{StaticResource ItemTBL}"/>
                                            <TextBlock 
                                                Grid.Row="5" 
                                                Grid.Column="1" 
                                                Text="Id 2: " 
                                                Style="{StaticResource ItemLocalHeaderTBL}"
                                                FontSize="12"/>
                                            <Button 
                                                Grid.Row="5" 
                                                Grid.Column="2" 
                                                Content="{Binding Element_2_Id}" 
                                                Style="{StaticResource ItemBTN}"
                                                VerticalContentAlignment="Top" 
                                                Click="SelectIdElement_2"
                                                FontSize="10"/>
                                            <TextBlock 
                                                Grid.Row="6" 
                                                Grid.Column="1" 
                                                Text="Данные 2: " 
                                                Style="{StaticResource ItemLocalHeaderTBL}"
                                                FontSize="12"/>
                                            <Expander
                                                Grid.Row="6" 
                                                Grid.Column="2"
                                                IsExpanded="False">
                                                <TextBlock 
                                                    Text="{Binding Element_2_Info}"
                                                    Style="{StaticResource ItemTBL}"
                                                    MaxWidth="300"/>
                                            </Expander>

                                            <!--Комменты от координатора-->
                                            <TextBlock 
                                                Grid.Row="7" 
                                                Grid.Column="1" 
                                                Text="Комментарий BIM: " 
                                                Visibility="{Binding ReportItemCommentsVisibility}" 
                                                Style="{StaticResource ItemLocalHeaderTBL}"
                                                FontSize="12"
                                                Foreground="Black"
                                                TextDecorations="Underline"/>
                                            <TextBlock 
                                                Grid.Row="7" 
                                                Grid.Column="2"
                                                Text="{Binding ReportItemComments}"  
                                                Visibility="{Binding ReportItemCommentsVisibility}" 
                                                Style="{StaticResource ItemTBL}"
                                                MaxWidth="300"
                                                Foreground="Black"
                                                FontWeight="Bold"
                                                FontSize="12"/>

                                            <!--Метка коллизий-->
                                            <Button 
                                                Grid.Row="6" 
                                                Grid.Column="0" 
                                                Click="PlacePoint" 
                                                Content="፠ Метка" 
                                                Visibility="{Binding PlacePointVisibility}" 
                                                Style="{StaticResource ItemBTN}"
                                                HorizontalAlignment="Center"
                                                Background="{x:Null}" 
                                                BorderBrush="White" 
                                                BorderThickness="2"
                                                FontSize="10"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>

                        <!--Кнопки устранения-->
                        <TextBlock Margin="4,3,0,0" Grid.Row="2" Grid.Column="0" Text="Статус конфликта:" Foreground="White"/>
                        <StackPanel Margin="0,0,0,4" Orientation="Horizontal" Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" Visibility="{Binding IsControllsVisible, UpdateSourceTrigger=PropertyChanged}">
                            <Button Height="25" Padding="5,0,5,0" x:Name="btn_corrected" Margin="3,10,0,0" Content="✔ Устранено" Background="{x:Null}" BorderBrush="White" Foreground="White" FontWeight="Bold" BorderThickness="2" Click="OnCorrected">
                                <Button.ToolTip>
                                    <StackPanel MaxWidth="300">
                                        <TextBlock TextWrapping="Wrap" FontWeight="Bold" Margin="0,0,0,5" Text="Устранено"/>
                                        <TextBlock TextWrapping="Wrap" Text="Пометить пересечение как «Устранено»"/>
                                        <Border BorderBrush="Silver" BorderThickness="0,1,0,0" Margin="0,8" />
                                        <TextBlock TextWrapping="Wrap" Text="Подсказка: Действие необходимо подтверждать развернутым комментарием (что фактически сделано/не сделано)" FontStyle="Italic"/>
                                    </StackPanel>
                                </Button.ToolTip>
                            </Button>
                            <Button Height="25" Padding="5,0,5,0" x:Name="btn_approved" Margin="3,10,0,0" Content="Допустимое" Background="{x:Null}" BorderBrush="White" Foreground="White" FontWeight="Bold" BorderThickness="2" Click="OnApproved">
                                <Button.ToolTip>
                                    <StackPanel MaxWidth="300">
                                        <TextBlock TextWrapping="Wrap" FontWeight="Bold" Margin="0,0,0,5" Text="Допустимое"/>
                                        <TextBlock TextWrapping="Wrap" Text="Пометить пересечение как «Допустимое»"/>
                                        <Border BorderBrush="Silver" BorderThickness="0,1,0,0" Margin="0,8" />
                                        <TextBlock TextWrapping="Wrap" Text="Подсказка: Действие необходимо подтверждать развернутым комментарием (что фактически сделано/не сделано)" FontStyle="Italic"/>
                                    </StackPanel>
                                </Button.ToolTip>
                            </Button>
                            <Button Height="25" Width="25" x:Name="btn_reset" Margin="3,10,0,0" Content="✖" Background="{x:Null}" BorderBrush="White" Foreground="White" FontWeight="Bold" BorderThickness="2" Click="OnReset">
                                <Button.ToolTip>
                                    <StackPanel MaxWidth="300">
                                        <TextBlock TextWrapping="Wrap" FontWeight="Bold" Margin="0,0,0,5" Text="Сбросить"/>
                                        <TextBlock TextWrapping="Wrap" Text="Сбросить статус пересечения на «Открытое»"/>
                                        <Border BorderBrush="Silver" BorderThickness="0,1,0,0" Margin="0,8" />
                                        <TextBlock TextWrapping="Wrap" Text="Подсказка: Действие необходимо подтверждать развернутым комментарием (что фактически сделано/не сделано)" FontStyle="Italic"/>
                                    </StackPanel>
                                </Button.ToolTip>
                            </Button>
                        </StackPanel>

                        <!--Кнопки делегирования-->
                        <TextBlock 
                            Grid.Row="2" 
                            Grid.Column="1"  
                            Text="Делегировать отделу:" 
                            Margin="4,3,0,0" 
                            Foreground="White"/>
                        <ItemsControl 
                            Grid.Row="3" 
                            Grid.Column="1" 
                            Margin="30,3,0,0" 
                            ItemsSource="{Binding SubDepartmentBtns}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="0,0,0,4" Orientation="Horizontal">
                                        <Button 
                                            x:Name="btn_delegate" 
                                            Height="25" 
                                            Width="50" 
                                            Padding="5,0,5,0" 
                                            Margin="3,10,0,0" 
                                            Content="{Binding Name}" 
                                            Background="{Binding DelegateBtnBackground, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                            BorderBrush="White" 
                                            Foreground="White" 
                                            FontWeight="Bold" 
                                            BorderThickness="2" 
                                            Click="OnDelegate">
                                            <Button.ToolTip>
                                                <TextBlock TextWrapping="Wrap" FontWeight="Bold" Margin="0,0,0,5" Text="{Binding Description}"/>
                                            </Button.ToolTip>
                                        </Button>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!--Блок комментирования-->
                        <TextBlock 
                            Margin="4,3,0,0"  
                            Grid.Row="4" 
                            Grid.Column="0" 
                            Text="Комментарии:" 
                            Foreground="White"/>
                        <StackPanel 
                            Grid.Row="4" 
                            Grid.Column="0" 
                            Grid.ColumnSpan="2" 
                            Margin="0,20,4,0" 
                            Orientation="Vertical">
                            <ItemsControl 
                                ItemsSource="{Binding CommentCollection, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid 
                                            Margin="6, 5, 5, 5" 
                                            HorizontalAlignment="Left">
                                            <Grid.RowDefinitions>
                                                <RowDefinition/>
                                                <RowDefinition/>
                                                <RowDefinition/>
                                            </Grid.RowDefinitions>
                                            
                                            <Rectangle 
                                                Grid.RowSpan="3" 
                                                Margin="-3" 
                                                RadiusX="3" 
                                                RadiusY="3" 
                                                Stroke="White" 
                                                StrokeThickness="2" Fill="#19FFFFFF"/>
                                            <StackPanel 
                                                Grid.Row="0" 
                                                Orientation="Horizontal">
                                                <TextBlock 
                                                    Text="От: " 
                                                    Foreground="White"/>
                                                <TextBlock 
                                                    Text="{Binding UserFullName}" 
                                                    Foreground="White"/>
                                                <TextBlock 
                                                    Text=" - " 
                                                    Foreground="White"/>
                                                <TextBlock 
                                                    Text="{Binding Time}" 
                                                    Foreground="White" 
                                                    Margin="0,0,25,0"/>
                                            </StackPanel>
                                            <Separator 
                                                Grid.Row="1" 
                                                Background="White" 
                                                Foreground="White"/>
                                            <TextBlock 
                                                Grid.Row="2"  
                                                Text="{Binding Message}" 
                                                TextWrapping="Wrap" 
                                                MaxWidth="700"
                                                Foreground="White"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                        <Button 
                            Grid.Row="5" 
                            Width="200"
                            Content="Комментировать" 
                            IsEnabled="{Binding IsControllsEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                            Style="{StaticResource ItemBTN}"
                            VerticalAlignment="Top" 
                            Margin="5" 
                            BorderBrush="White" 
                            BorderThickness="2"
                            Click="OnAddComment"/>
                    </Grid>
                    <DataTemplate.Triggers>
                        <DataTrigger 
                            Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" 
                            Value="True">
                            <Setter 
                                TargetName="BackgroundRect" 
                                Property="Stroke" 
                                Value="Black"/>
                            <Setter 
                                TargetName="BackgroundRect" 
                                Property="StrokeThickness" 
                                Value="5"/>
                        </DataTrigger>
                    </DataTemplate.Triggers>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        
        <!--Блок обновления-->
        <DockPanel 
            Grid.Row="4" 
            Grid.ColumnSpan="2">
            <Button 
                x:Name="btnUpdate" 
                Content="Обновить отчеты"
                Click="OnBtnUpdate"
                Style="{StaticResource ItemBTN}"
                Margin="5,0,5,5"
                BorderBrush="White">
                <Button.ToolTip>
                    <StackPanel MaxWidth="300">
                        <TextBlock 
                            TextWrapping="Wrap" 
                            Text="Подсказка: Обновляет статусы по отчетам" 
                            FontStyle="Italic"/>
                    </StackPanel>
                </Button.ToolTip>
            </Button>
        </DockPanel>
        
    </Grid>
</Window>
